<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - SoloSafe</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
      <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <!-- Hamburger Menu Button -->
    <button class="hamburger-btn" onclick="showSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" onclick="closeSidebar()"></div>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <!-- <div class="logo-circle">SS</div>
            <span class="brand-name sidebar-text" style="color: white;">SoloSafe</span> -->
            <img src="/images/logo-solo.jpg" width="25px" class="me-3" alt="logo-solo">
            <h4 class="fw-bolder font-color pt-2">SoloSafe</h4>
            <button class="btn btn-sm btn-light d-none d-lg-block ms-auto" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
        </div>

        <ul class="sidebar-nav">
            <li>
                <a href="dashboard.html">
                    <i class="fas fa-home"></i>
                    <span class="sidebar-text">Dashboard</span>
                </a>
            </li>
            
            <li>
                <a href="settings.html" class="active">
                    <i class="fas fa-cog"></i>
                    <span class="sidebar-text">Settings</span>
                </a>
            </li>
        </ul>

        <div class="sidebar-footer">
            <button class="btn btn-danger" onclick="logout()">
                <i class="fas fa-sign-out-alt me-2"></i>Logout
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="dashboard-header">
            <div>
                <h2>Settings</h2>
                <p class="text-muted mb-0">Manage your account and preferences</p>
            </div>
            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-outline-primary" onclick="toggleDarkMode()">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8">
                <!-- Profile Settings -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title mb-4">
                            <i class="fas fa-user me-2"></i>Profile Information
                        </h5>

                        <!-- Profile Picture -->
                        <div class="text-center mb-4">
                            <div style="position: relative; display: inline-block;">
                                <img src="https://ui-avatars.com/api/?name=User&background=667eea&color=fff"
                                    alt="Profile" class="rounded-circle mb-3" id="profilePicPreview"
                                    style="width: 120px; height: 120px; object-fit: cover; border: 4px solid #667eea;">
                                <div class="online-indicator"
                                    style="width: 20px; height: 20px; bottom: 15px; right: 5px;"></div>
                            </div>
                            <div>
                                <input type="file" id="profilePicInput" accept="image/*" style="display: none;">
                                <button class="btn btn-sm btn-outline-primary"
                                    onclick="document.getElementById('profilePicInput').click()">
                                    <i class="fas fa-camera me-1"></i>Change Picture
                                </button>
                            </div>
                        </div>

                        <form id="profileForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="fullName" class="form-label">Full Name</label>
                                    <input type="text" class="form-control" id="fullName" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="username" class="form-label">Username</label>
                                    <input type="text" class="form-control" id="username" required>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="email" class="form-label">Email Address</label>
                                <input type="email" class="form-control" id="email" required>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="country" class="form-label">Country</label>
                                    <select class="form-select" id="country">
                                        <option value="United States">United States</option>
                                        <option value="United Kingdom">United Kingdom</option>
                                        <option value="Canada">Canada</option>
                                        <option value="Australia">Australia</option>
                                        <option value="Germany">Germany</option>
                                        <option value="France">France</option>
                                        <option value="Spain">Spain</option>
                                        <option value="Italy">Italy</option>
                                        <option value="Japan">Japan</option>
                                        <option value="India">India</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="phone" class="form-label">Phone Number</label>
                                    <input type="tel" class="form-control" id="phone">
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Save Changes
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Appearance Settings -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title mb-4">
                            <i class="fas fa-palette me-2"></i>Appearance
                        </h5>

                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>Dark Mode</strong>
                                <p class="text-muted small mb-0">Switch between light and dark theme</p>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="darkModeToggle"
                                    style="width: 50px; height: 25px;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Security Settings -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title mb-4">
                            <i class="fas fa-shield-alt me-2"></i>Security
                        </h5>

                        <button class="btn btn-outline-primary" data-bs-toggle="modal"
                            data-bs-target="#changePasswordModal">
                            <i class="fas fa-key me-2"></i>Change Password
                        </button>
                    </div>
                </div>

                <!-- Data & Privacy -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title mb-4">
                            <i class="fas fa-database me-2"></i>Data & Privacy
                        </h5>

                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <strong>Download Your Data</strong>
                                <p class="text-muted small mb-0">Get a copy of all your trips and information</p>
                            </div>
                            <button class="btn btn-outline-primary" onclick="downloadUserData()">
                                <i class="fas fa-download me-2"></i>Download
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Danger Zone -->
                <div class="card border-danger mb-4">
                    <div class="card-body">
                        <h5 class="card-title text-danger mb-4">
                            <i class="fas fa-exclamation-triangle me-2"></i>Danger Zone
                        </h5>

                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>Logout</strong>
                                <p class="text-muted small mb-0">Sign out of your account</p>
                            </div>
                            <button class="btn btn-danger" onclick="logout()">
                                <i class="fas fa-sign-out-alt me-2"></i>Logout
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <!-- Quick Info Card -->
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-info-circle me-2"></i>Account Info
                        </h5>
                        <div class="mb-3">
                            <small class="text-muted">Member Since</small>
                            <p class="mb-0" id="memberSince">-</p>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted">Total Trips</small>
                            <p class="mb-0" id="totalTrips">0</p>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted">Emergency Contacts</small>
                            <p class="mb-0" id="totalContacts">0</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Change Password Modal -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-key me-2"></i>Change Password
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm">
                        <div class="mb-3">
                            <label for="currentPassword" class="form-label">Current Password</label>
                            <input type="password" class="form-control" id="currentPassword" required>
                        </div>

                        <div class="mb-3">
                            <label for="newPassword" class="form-label">New Password</label>
                            <input type="password" class="form-control" id="newPassword" required>
                            <small class="text-muted">At least 6 characters</small>
                        </div>

                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">Confirm New Password</label>
                            <input type="password" class="form-control" id="confirmPassword" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveNewPassword()">
                        <i class="fas fa-save me-2"></i>Change Password
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- âœ… ADD THIS (before script.js) -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="script.js"></script>
    <script>
        const user = getCurrentUser();
        if (!user) window.location.href = 'login.html';

        // Populate form
        document.getElementById('fullName').value = user.name || '';
        document.getElementById('username').value = user.username || '';
        document.getElementById('email').value = user.email || '';
        document.getElementById('country').value = user.nationality || 'United States';
        document.getElementById('phone').value = user.phone || '';

        // Set profile picture
        if (user.profilePicture) {
            document.getElementById('profilePicPreview').src = user.profilePicture;
        }

        // Set account info
        const trips = JSON.parse(localStorage.getItem('solosafe_trips') || '[]');
        const contacts = JSON.parse(localStorage.getItem('solosafe_contacts') || '[]');

        document.getElementById('memberSince').textContent =
            new Date(user.createdAt || Date.now()).toLocaleDateString();
        document.getElementById('totalTrips').textContent = trips.length;
        document.getElementById('totalContacts').textContent = contacts.length;

        // Dark mode toggle
        const darkModeToggle = document.getElementById('darkModeToggle');
        darkModeToggle.checked = localStorage.getItem('solosafe_dark_mode') === 'true';

        darkModeToggle.addEventListener('change', function () {
            toggleDarkMode();
        });

        // Profile picture upload
        document.getElementById('profilePicInput').addEventListener('change', async function (e) {
            const file = e.target.files[0];
            if (file) {
                try {
                    const dataURL = await uploadProfilePicture(file);
                    document.getElementById('profilePicPreview').src = dataURL;
                } catch (error) {
                    showToast('Failed to upload picture', 'error');
                }
            }
        });

        // Phone input validation
        document.getElementById('phone').addEventListener('input', function (e) {
            const value = e.target.value;
            const phoneRegex = /^[\d\s()+-]*$/;
            if (!phoneRegex.test(value)) {
                this.value = value.slice(0, -1);
            }
        });

        // Profile form submission
        document.getElementById('profileForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const updates = {
                name: document.getElementById('fullName').value.trim(),
                username: document.getElementById('username').value.trim(),
                email: document.getElementById('email').value.trim(),
                nationality: document.getElementById('country').value,
                phone: document.getElementById('phone').value.trim()
            };

            // Validate username
            const usernameRegex = /^[a-zA-Z0-9_]{3,20}$/;
            if (!usernameRegex.test(updates.username)) {
                showToast('Username must be 3-20 characters, alphanumeric and underscore only', 'error');
                return;
            }

            updateUserProfile(updates);
            showToast('Profile updated successfully!', 'success');
        });

        // Change password
        function saveNewPassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                showToast('Passwords do not match', 'error');
                return;
            }

            if (changePassword(currentPassword, newPassword)) {
                document.getElementById('changePasswordForm').reset();
                const modal = bootstrap.Modal.getInstance(document.getElementById('changePasswordModal'));
                modal.hide();
            }
        }

        // Make functions global
        window.saveNewPassword = saveNewPassword;
    </script>
</body>

</html>