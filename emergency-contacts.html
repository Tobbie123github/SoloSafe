<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency Contacts - SoloSafe</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
     <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <!-- Hamburger Menu Button -->
    <button class="hamburger-btn" onclick="showSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" onclick="closeSidebar()"></div>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <img src="/images/logo-solo.jpg" width="25px" class="me-3" alt="logo-solo">
            <h4 class="fw-bolder font-color pt-2">SoloSafe</h4>
            <button class="btn btn-sm btn-light d-none d-lg-block ms-auto" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
        </div>

        <ul class="sidebar-nav">
            <li><a href="dashboard.html"><i class="fas fa-home"></i><span class="sidebar-text">Dashboard</span></a></li>

            <li><a href="settings.html"><i class="fas fa-cog"></i><span class="sidebar-text">Settings</span></a></li>
        </ul>

        <div class="sidebar-footer">
            <a href="#" onclick="logout(); return false;">
                <i class="fas fa-sign-out-alt"></i><span class="sidebar-text">Logout</span>
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="dashboard-header d-flex justify-content-between align-items-center">
            <div>
                <h2>Emergency Contacts</h2>
                <p class="text-muted mb-0">Manage your trusted contacts who will be notified in emergencies</p>
            </div>
            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-outline-primary" onclick="toggleDarkMode()"><i class="fas fa-moon"></i></button>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addContactModal">
                    <i class="fas fa-plus me-2"></i>Add Contact
                </button>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-4">Your Emergency Contacts</h5>
                        <div id="contactsContainer" class="text-center py-5 text-muted">
                            <i class="fas fa-user-friends fa-3x mb-3 d-block"></i>
                            No emergency contacts added yet. Add your first contact to get started!
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-info-circle me-2"></i>About Emergency Contacts</h5>
                        <p class="small text-muted">Emergency contacts are notified when:</p>
                        <ul class="small">
                            <li>You trigger an SOS alert</li>
                            <li>You miss a check-in after grace period</li>
                            <li>Location tracking detects unusual activity</li>
                        </ul>
                        <hr>
                        <h6>Best Practices:</h6>
                        <ul class="small">
                            <li>Add at least 2-3 trusted contacts</li>
                            <li>Include family and close friends</li>
                            <li>Verify contact information is correct</li>
                            <li>Inform contacts they're listed</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Add Contact Modal -->
    <div class="modal fade" id="addContactModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-user-plus me-2"></i>Add Emergency Contact</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addContactForm">
                        <div class="mb-3">
                            <label for="contactName" class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="contactName" required>
                        </div>
                        <div class="mb-3">
                            <label for="contactEmail" class="form-label">Email Address</label>
                            <input type="email" class="form-control" id="contactEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="contactPhone" class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="contactPhone" placeholder="+1 555-123-4567" required>
                        </div>
                        <div class="alert alert-info">
                            <small><i class="fas fa-info-circle me-1"></i>
                                This contact will receive alerts via email and SMS when you trigger an SOS or miss a check-in.
                            </small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="saveContactBtn" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Save Contact
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap & Script -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
     <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
     <script src="script.js"></script> 

    <!-- Main JS -->
   <script>
     
    
document.addEventListener('DOMContentLoaded', async () => {
const user = getCurrentUser();
    if (!user) {
        window.location.href = 'login.html';
        return;
    }
    /* -----------------------------
       1. CAPTURE tripId
    ------------------------------ */
    const params = new URLSearchParams(window.location.search);
    const tripId = params.get('tripId');

    if (!tripId) {
        alert('Missing trip information.');
        return;
    }

    /* -----------------------------
       2. ELEMENT REFERENCES
    ------------------------------ */
    const contactsContainer = document.getElementById('contactsContainer');
    const saveBtn = document.getElementById('saveContactBtn');
    const form = document.getElementById('addContactForm');

    let allContacts = [];

    /* -----------------------------
       3. LOAD CONTACTS (GET)
    ------------------------------ */
    async function loadContacts() {
         const auth = JSON.parse(localStorage.getItem("solosafe_user"));

    const bearerToken = `Bearer ${auth.token}`;
        try {
            const res = await fetch(
                `https://solosafe-backend.onrender.com/api/trips/${tripId}/contacts`,
                {  headers: {
                'Content-Type': 'application/json',
                'Authorization': bearerToken
            }   }
            );

            const data = await res.json();
            console.log('GET contacts:', data);

            // ✅ support multiple backend response shapes
            allContacts =
                data.emergencyContacts ||
                data.trip?.emergencyContacts ||
                [];

            renderContacts();
        } catch (err) {
            console.error(err);
            contactsContainer.innerHTML = `
                <p class="text-danger text-center py-5">
                    Failed to load emergency contacts
                </p>`;
        }
    }

    /* -----------------------------
       4. RENDER CONTACTS
    ------------------------------ */
    function renderContacts() {
        if (!allContacts.length) {
            contactsContainer.innerHTML = `
                <p class="text-muted text-center py-5">
                    <i class="fas fa-user-friends fa-3x mb-3 d-block"></i>
                    No emergency contacts added yet.
                </p>`;
            return;
        }

        contactsContainer.innerHTML = allContacts.map(contact => `
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center gap-3">
                        <div class="flex-grow-1 text-start align-items-start>
                            <h6 class="mb-1">${contact.name}</h6>
                            <small class="text-muted d-block">${contact.email}</small>
                            <small class="text-muted">${contact.phone}</small>
                        </div>
                        <button class="btn btn-outline-danger btn-sm"
                                data-id="${contact._id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `).join('');

        contactsContainer
            .querySelectorAll('button[data-id]')
            .forEach(btn =>
                btn.addEventListener('click', () =>
                    deleteContact(btn.dataset.id)
                )
            );
    }

    /* -----------------------------
       5. SAVE CONTACT
    ------------------------------ */
    saveBtn.addEventListener('click', async () => {
        const name  = document.getElementById('contactName').value.trim();
        const email = document.getElementById('contactEmail').value.trim();
        const phone = document.getElementById('contactPhone').value.trim();

        if (!name || !email || !phone) {
            alert('Please fill all fields');
            return;
        }

        const originalHTML = saveBtn.innerHTML;
        saveBtn.disabled = true;
        saveBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>Saving...`;

        try {
             const auth = JSON.parse(localStorage.getItem("solosafe_user"));

    const bearerToken = `Bearer ${auth.token}`;
            const res = await fetch(
                `https://solosafe-backend.onrender.com/api/trips/${tripId}/contacts`,
                {
                    method: 'PUT',
                   
                    headers: {
                'Content-Type': 'application/json',
                'Authorization': bearerToken
            },
                    body: JSON.stringify({ name, email, phone })
                }
            );

            const data = await res.json();
            console.log('PUT contact:', data);

            if (!res.ok) {
                throw new Error(data.message || 'Failed to save contact');
                showToast('Failed to save contact', 'error');
            }

            showToast('Contact added successfully', 'success');

            // ✅ refresh list from backend truth
            allContacts =
                data.trip?.emergencyContacts ||
                data.emergencyContacts ||
                allContacts;

            renderContacts();

            form.reset();
            bootstrap.Modal
                .getInstance(document.getElementById('addContactModal'))
                .hide();

        } catch (err) {
            console.error(err);
            alert(err.message);
        } finally {
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalHTML;
        }
    });

    /* -----------------------------
       6. DELETE CONTACT
    ------------------------------ */
    async function deleteContact(contactId) {
        if (!confirm('Remove this contact?')) return;
             const auth = JSON.parse(localStorage.getItem("solosafe_user"));

    const bearerToken = `Bearer ${auth.token}`;
        try {
            const res = await fetch(
                `https://solosafe-backend.onrender.com/api/trips/${tripId}/contacts/${contactId}`,
                { method: 'DELETE', headers: {
                'Content-Type': 'application/json',
                'Authorization': bearerToken
            } }
            );

            if (!res.ok) throw new Error('Failed to delete contact');

            showToast('Contact deleted', 'success');

            allContacts = allContacts.filter(c => c._id !== contactId);
            renderContacts();

        } catch (err) {
            console.error(err);
          showToast('Error deleting contact', 'error');
        }
    }

    /* -----------------------------
       7. INITIAL LOAD
    ------------------------------ */
    await loadContacts();

});
</script>


</body>
</html>
